# üèóÔ∏è Arquitectura Completa - VIDA SC

## üìä Resumen Ejecutivo

**Base de Datos Recomendada:** Supabase PostgreSQL (ya integrada)

**Almacenamiento de Archivos:** Supabase Storage

---

## üéØ Funcionalidades a Implementar

### 1. üìç **Delegaciones** (Sedes)
- Informaci√≥n de cada delegaci√≥n
- Responsables y miembros
- Ubicaci√≥n y contacto
- Archivos espec√≠ficos por delegaci√≥n

### 2. üìÅ **Gesti√≥n de Archivos** (PDFs, Documentos)
- Control de acceso por rol
- Organizaci√≥n por categor√≠as
- Historial de descargas
- B√∫squeda y filtros

### 3. üìù **Blog**
- Posts con im√°genes
- Categor√≠as y tags
- Control de publicaci√≥n
- Vistas y estad√≠sticas

---

## üóÑÔ∏è Arquitectura de Base de Datos

### Tablas Creadas:

| Tabla | Prop√≥sito | Acceso |
|-------|-----------|--------|
| `delegaciones` | Info de sedes | Todos autenticados |
| `blog_posts` | Posts del blog | P√∫blicos si publicados |
| `archivos` | Metadata de archivos | Seg√∫n rol |
| `delegacion_miembros` | Usuarios por delegaci√≥n | Miembros y admins |
| `categorias` | Organizaci√≥n de contenido | Todos |
| `archivo_descargas` | Auditor√≠a de descargas | Solo admins |

### Diagrama de Relaciones:

```
auth.users (Supabase Auth)
    ‚îú‚îÄ‚Üí user_roles ‚Üê‚Üí roles
    ‚îú‚îÄ‚Üí delegacion_miembros ‚Üê‚Üí delegaciones
    ‚îú‚îÄ‚Üí blog_posts
    ‚îî‚îÄ‚Üí archivos
```

---

## üìÅ Supabase Storage - Configuraci√≥n

### Paso 1: Crear Bucket

1. Ve a Supabase Dashboard
2. Storage ‚Üí New Bucket
3. Nombre: `vida-storage`
4. **P√∫blico:** NO (lo controlaremos con pol√≠ticas)

### Paso 2: Pol√≠ticas de Storage

Ejecuta en SQL Editor:

```sql
-- Pol√≠tica para subir archivos (solo admin y pastor)
CREATE POLICY "Admins y pastores pueden subir archivos"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'vida-storage' AND
  EXISTS (
    SELECT 1 FROM public.user_roles ur
    INNER JOIN public.roles r ON r.id = ur.role_id
    WHERE ur.user_id = auth.uid()
    AND r.name IN ('admin', 'pastor')
  )
);

-- Pol√≠tica para leer archivos (seg√∫n la carpeta y rol)
CREATE POLICY "Usuarios pueden descargar seg√∫n su rol"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'vida-storage' AND
  (
    -- Carpeta p√∫blica
    (storage.foldername(name))[1] = 'public' OR
    -- Admin puede todo
    EXISTS (
      SELECT 1 FROM public.user_roles ur
      INNER JOIN public.roles r ON r.id = ur.role_id
      WHERE ur.user_id = auth.uid() AND r.name = 'admin'
    ) OR
    -- Archivos seg√∫n rol
    (
      (storage.foldername(name))[1] = 'protected' AND
      (
        ((storage.foldername(name))[2] = 'admin' AND user_has_role(auth.uid(), 'admin')) OR
        ((storage.foldername(name))[2] = 'pastor' AND user_has_role(auth.uid(), 'pastor')) OR
        ((storage.foldername(name))[2] = 'lider' AND user_has_role(auth.uid(), 'lider')) OR
        ((storage.foldername(name))[2] = 'celula' AND user_has_role(auth.uid(), 'celula'))
      )
    )
  )
);

-- Pol√≠tica para actualizar archivos (solo quien los subi√≥ o admin)
CREATE POLICY "Solo creador o admin pueden actualizar archivos"
ON storage.objects FOR UPDATE
TO authenticated
USING (
  bucket_id = 'vida-storage' AND
  (
    owner = auth.uid() OR
    EXISTS (
      SELECT 1 FROM public.user_roles ur
      INNER JOIN public.roles r ON r.id = ur.role_id
      WHERE ur.user_id = auth.uid() AND r.name = 'admin'
    )
  )
);

-- Pol√≠tica para eliminar archivos (solo admin)
CREATE POLICY "Solo admins pueden eliminar archivos"
ON storage.objects FOR DELETE
TO authenticated
USING (
  bucket_id = 'vida-storage' AND
  is_admin(auth.uid())
);
```

---

## üé® Estructura de Carpetas en Storage

```
vida-storage/
‚îÇ
‚îú‚îÄ‚îÄ public/                      # ‚úÖ Acceso: Todos
‚îÇ   ‚îú‚îÄ‚îÄ blog-images/            # Im√°genes del blog
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ portadas/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ contenido/
‚îÇ   ‚îú‚îÄ‚îÄ delegaciones/           # Fotos de sedes
‚îÇ   ‚îî‚îÄ‚îÄ general/                # Logos, im√°genes generales
‚îÇ
‚îî‚îÄ‚îÄ protected/                   # üîí Acceso: Seg√∫n rol
    ‚îú‚îÄ‚îÄ admin/                  # Solo admin
    ‚îÇ   ‚îú‚îÄ‚îÄ reportes/
    ‚îÇ   ‚îú‚îÄ‚îÄ financiero/
    ‚îÇ   ‚îî‚îÄ‚îÄ confidencial/
    ‚îÇ
    ‚îú‚îÄ‚îÄ pastor/                 # Admin + Pastor
    ‚îÇ   ‚îú‚îÄ‚îÄ sermones/
    ‚îÇ   ‚îú‚îÄ‚îÄ estudios/
    ‚îÇ   ‚îî‚îÄ‚îÄ planificacion/
    ‚îÇ
    ‚îú‚îÄ‚îÄ lider/                  # Admin + Pastor + L√≠der
    ‚îÇ   ‚îú‚îÄ‚îÄ capacitacion/
    ‚îÇ   ‚îú‚îÄ‚îÄ materiales/
    ‚îÇ   ‚îî‚îÄ‚îÄ guias/
    ‚îÇ
    ‚îú‚îÄ‚îÄ celula/                 # Admin + Pastor + L√≠der + C√©lula
    ‚îÇ   ‚îú‚îÄ‚îÄ estudios-semanales/
    ‚îÇ   ‚îî‚îÄ‚îÄ recursos/
    ‚îÇ
    ‚îî‚îÄ‚îÄ delegaciones/           # Por delegaci√≥n espec√≠fica
        ‚îú‚îÄ‚îÄ delegacion-norte/
        ‚îú‚îÄ‚îÄ delegacion-sur/
        ‚îî‚îÄ‚îÄ delegacion-centro/
```

---

## üîÑ Flujo de Subida de Archivos

### Diagrama:

```
1. Usuario (admin/pastor) selecciona archivo
   ‚Üì
2. Frontend valida: tipo, tama√±o, formato
   ‚Üì
3. Sube a Supabase Storage (carpeta seg√∫n rol_minimo)
   ‚Üì
4. Storage devuelve: storage_path
   ‚Üì
5. Frontend crea registro en tabla 'archivos'
   {
     nombre,
     storage_path,
     rol_minimo,
     delegacion_id (opcional),
     subido_por: user.id
   }
   ‚Üì
6. Backend aplica RLS: verifica permisos
   ‚Üì
7. ‚úÖ Archivo disponible para usuarios con rol adecuado
```

---

## üíª Ejemplo de C√≥digo para Subir Archivo

### API Route: `/api/archivos/upload`

```typescript
// vida-web/app/api/archivos/upload/route.ts

import { NextResponse } from 'next/server'
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function POST(request: Request) {
  try {
    const cookieStore = await cookies()
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() { return cookieStore.getAll() },
          setAll(cookiesToSet) {},
        },
      }
    )

    const { data: { user }, error: authError } = await supabase.auth.getUser()
    
    if (authError || !user) {
      return NextResponse.json({ error: 'No autorizado' }, { status: 401 })
    }

    // Verificar que sea admin o pastor
    const { data: userRoles } = await supabase
      .rpc('get_user_roles', { user_uuid: user.id })
    
    const canUpload = userRoles?.some(
      (role: any) => ['admin', 'pastor'].includes(role.role_name)
    )
    
    if (!canUpload) {
      return NextResponse.json(
        { error: 'No tienes permisos para subir archivos' },
        { status: 403 }
      )
    }

    const formData = await request.formData()
    const file = formData.get('file') as File
    const rolMinimo = formData.get('rol_minimo') as string
    const categoria = formData.get('categoria') as string
    const descripcion = formData.get('descripcion') as string
    
    if (!file) {
      return NextResponse.json({ error: 'No se proporcion√≥ archivo' }, { status: 400 })
    }

    // Construir path seg√∫n rol
    const folder = rolMinimo === 'admin' ? 'protected/admin' : 
                   rolMinimo === 'pastor' ? 'protected/pastor' :
                   rolMinimo === 'lider' ? 'protected/lider' :
                   rolMinimo === 'celula' ? 'protected/celula' : 'protected/general'
    
    const fileName = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`
    const storagePath = `${folder}/${fileName}`

    // Subir a Storage
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from('vida-storage')
      .upload(storagePath, file, {
        cacheControl: '3600',
        upsert: false
      })

    if (uploadError) {
      console.error('Error uploading to storage:', uploadError)
      return NextResponse.json({ error: uploadError.message }, { status: 500 })
    }

    // Crear registro en tabla archivos
    const { data: archivoData, error: dbError } = await supabase
      .from('archivos')
      .insert({
        nombre: file.name,
        descripcion,
        tipo_archivo: file.type,
        tamano: file.size,
        storage_path: storagePath,
        storage_bucket: 'vida-storage',
        rol_minimo: rolMinimo,
        categoria,
        subido_por: user.id,
      })
      .select()
      .single()

    if (dbError) {
      // Si falla la BD, eliminar archivo de storage
      await supabase.storage.from('vida-storage').remove([storagePath])
      console.error('Error creating database record:', dbError)
      return NextResponse.json({ error: dbError.message }, { status: 500 })
    }

    return NextResponse.json({ 
      archivo: archivoData,
      message: 'Archivo subido exitosamente' 
    }, { status: 201 })

  } catch (error) {
    console.error('Error in upload API:', error)
    return NextResponse.json(
      { error: 'Error interno del servidor' },
      { status: 500 }
    )
  }
}
```

---

## üì• Ejemplo de Descarga de Archivo

### API Route: `/api/archivos/download/[id]`

```typescript
// vida-web/app/api/archivos/download/[id]/route.ts

import { NextResponse } from 'next/server'
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const cookieStore = await cookies()
    const supabase = createServerClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
      {
        cookies: {
          getAll() { return cookieStore.getAll() },
          setAll(cookiesToSet) {},
        },
      }
    )

    const { data: { user }, error: authError } = await supabase.auth.getUser()
    
    if (authError || !user) {
      return NextResponse.json({ error: 'No autorizado' }, { status: 401 })
    }

    // Verificar permisos con la funci√≥n SQL
    const { data: canAccess } = await supabase
      .rpc('user_can_access_file', {
        user_uuid: user.id,
        file_id: params.id
      })

    if (!canAccess) {
      return NextResponse.json(
        { error: 'No tienes permisos para acceder a este archivo' },
        { status: 403 }
      )
    }

    // Obtener info del archivo
    const { data: archivo, error: fileError } = await supabase
      .from('archivos')
      .select('*')
      .eq('id', params.id)
      .single()

    if (fileError || !archivo) {
      return NextResponse.json({ error: 'Archivo no encontrado' }, { status: 404 })
    }

    // Obtener URL firmada de descarga (v√°lida por 60 segundos)
    const { data: signedUrl, error: urlError } = await supabase.storage
      .from(archivo.storage_bucket)
      .createSignedUrl(archivo.storage_path, 60)

    if (urlError) {
      return NextResponse.json({ error: urlError.message }, { status: 500 })
    }

    // Registrar descarga
    await supabase.from('archivo_descargas').insert({
      archivo_id: params.id,
      user_id: user.id,
    })

    // Incrementar contador
    await supabase.rpc('increment_download_count', { file_id: params.id })

    return NextResponse.json({
      downloadUrl: signedUrl.signedUrl,
      archivo: {
        nombre: archivo.nombre,
        tipo: archivo.tipo_archivo,
        tamano: archivo.tamano
      }
    })

  } catch (error) {
    console.error('Error in download API:', error)
    return NextResponse.json(
      { error: 'Error interno del servidor' },
      { status: 500 }
    )
  }
}
```

---

## üìä Comparaci√≥n: Supabase vs Otra BD

| Aspecto | Supabase (Recomendado) | BD Separada |
|---------|------------------------|-------------|
| **Integraci√≥n Auth** | ‚úÖ Nativa | ‚ùå Manual |
| **Almacenamiento** | ‚úÖ Storage incluido | ‚ùå Servidor FTP/S3 |
| **Seguridad RLS** | ‚úÖ Autom√°tica | ‚ùå Manual en c√≥digo |
| **APIs REST** | ‚úÖ Auto-generadas | ‚ùå Crear desde cero |
| **Realtime** | ‚úÖ Incluido | ‚ùå Websockets manual |
| **Escalabilidad** | ‚úÖ Autom√°tica | ‚ö†Ô∏è Depende del hosting |
| **Costo inicial** | ‚úÖ Gratis hasta 500MB BD | Var√≠a |
| **Complejidad** | ‚úÖ Baja | ‚ö†Ô∏è Alta |

### üéØ Recomendaci√≥n Final: **Supabase** ‚úÖ

**¬øPor qu√©?**
- Todo integrado (Auth + BD + Storage)
- Ya lo tienes funcionando
- Menos c√≥digo que mantener
- M√°s seguro (RLS integrado)
- Escalable sin esfuerzo

---

## üöÄ Plan de Implementaci√≥n

### Fase 1: Base de Datos (1-2 d√≠as)
- ‚úÖ Ejecutar `002_add_content_system.sql`
- ‚úÖ Crear bucket en Storage
- ‚úÖ Configurar pol√≠ticas de Storage
- ‚úÖ Probar subida/descarga manual

### Fase 2: APIs (3-4 d√≠as)
- Crear API de upload
- Crear API de download
- Crear API de listado de archivos
- APIs de delegaciones
- APIs de blog

### Fase 3: UI Admin (5-7 d√≠as)
- Componente de subida de archivos
- Gestor de archivos (lista, filtros, b√∫squeda)
- CRUD de delegaciones
- Editor de blog posts

### Fase 4: UI P√∫blica (3-5 d√≠as)
- P√°gina de delegaciones
- Blog p√∫blico
- Descarga de archivos permitidos

---

## üìà L√≠mites y Escalabilidad

### Plan Gratuito de Supabase:
- ‚úÖ 500 MB de base de datos
- ‚úÖ 1 GB de almacenamiento
- ‚úÖ 2 GB de transferencia/mes
- ‚úÖ 50,000 usuarios autenticados
- ‚úÖ 50 MB por archivo

### ¬øCu√°ndo necesitas pagar?
- M√°s de 500 usuarios activos/mes
- M√°s de 100 archivos grandes (>10MB)
- M√°s de 10,000 descargas/mes

### Plan Pro ($25/mes):
- 8 GB de base de datos
- 100 GB de almacenamiento
- 200 GB de transferencia
- 100,000 usuarios

---

## üéì Pr√≥ximos Pasos

1. **Ejecuta la migraci√≥n SQL** (`002_add_content_system.sql`)
2. **Crea el bucket** en Supabase Storage
3. **Configura las pol√≠ticas** de Storage
4. **Prueba subir un archivo** manualmente
5. **Crea las APIs** de upload/download
6. **Desarrolla la UI** de gesti√≥n

---

## üìû ¬øNecesitas ayuda?

Consulta los archivos:
- `ROLES_DOCUMENTATION.md` - Sistema de roles
- `002_add_content_system.sql` - Schema completo
- Este archivo - Arquitectura general

**¬°Todo est√° listo para empezar a desarrollar!** üöÄ

